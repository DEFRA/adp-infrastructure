name: 1.0.$(BuildID)-${{ parameters.deployResources }}

parameters:
  - name: deployFromFeature
    displayName: "Deploy from Feature Branch"
    type: boolean
    default: false
  - name: deployResources
    displayName: "Resources to Deploy"
    type: string
    default: "All"
    values:
      - All
      - Network
      - Platform Key Vault
      - Platform Container Registry
      - Platform Log Analytics Workspace
      - Platform Event Hub Namespace

pr:
  branches:
    include:
      - main
  paths:
    include:
      - infra/bootstrap/env-shared/*

trigger:
  batch: true
  branches:
    include:
      - '*'
  paths:
    include:
      - infra/bootstrap/env-shared/*
      - infra/common/policy-assignment/*

resources:
  repositories:
    - repository: ADPPipelineCommon
      name: DEFRA/adp-pipeline-common
      endpoint: DEFRA
      type: github
      ref: feature/renameSsvSharedEnvResources

variables:
  - name: IsAll
    value: ${{ eq(parameters.deployResources,'All') }}
  - name: IsNetwork
    value: ${{ or(eq(variables.IsAll,true), eq(parameters.deployResources,'Network')) }}
  - name: IsPolicyAssignments
    value: ${{ or(eq(variables.IsAll,true), eq(parameters.deployResources,'Policy Assignments')) }}
  - name: IsKeyVault
    value: ${{ or(eq(variables.IsAll,true), eq(parameters.deployResources,'Platform Key Vault')) }}
  - name: IsContainerRegistry
    value: ${{ or(eq(variables.IsAll,true), eq(parameters.deployResources,'Platform Container Registry')) }}
  - name: IsLogAnalyticsWorkspace
    value: ${{ or(eq(variables.IsAll,true), eq(parameters.deployResources,'Platform Log Analytics Workspace')) }}
  - name: IsEventHubNamespace
    value: ${{ or(eq(variables.IsAll,true), eq(parameters.deployResources,'Platform Event Hub Namespace')) }}

extends:
  template: /pipelines/common-infra-deploy.yaml@ADPPipelineCommon
  parameters:
    projectName: $(projectName)
    deployFromFeature: ${{ parameters.deployFromFeature }}
    environments:
      - name: 'ssv3'
        serviceConnection: AZD-ADP-SSV3
        deploymentBranches:
          - 'refs/heads/main'
        developmentEnvironment: true
        azureRegions:
          primary: 'UKSouth'
      - name: 'ssv5'
        serviceConnection: AZR-ADP-SSV5
        deploymentBranches:
          - 'refs/heads/main'
        azureRegions:
          primary: 'UKSouth'    
    groupedDeployments:
         - name: SharedEnvironment
           deployments:
            - ${{ if eq(variables.IsNetwork,true) }}:
              - name: route-table
                path: infra/core/env-shared/network
                serviceConnectionVariableName: "subscriptionName"
                resourceGroupName: $(ssvVirtualNetworkResourceGroup)
              - name: network-security-group
                path: infra/core/env-shared/network
                serviceConnectionVariableName: "subscriptionName"
                resourceGroupName: $(ssvVirtualNetworkResourceGroup)
              # - name: virtual-network
              #   path: infra/core/env-shared/network
              #   serviceConnectionVariableName: "subscriptionName"
              #   resourceGroupName: $(ssvVirtualNetworkResourceGroup)
            - ${{ if eq(variables.IsKeyVault,true) }}:
              - name: platform-key-vault
                path: infra/bootstrap/env-shared/key-vault
                resourceGroupName: $(ssvSharedResourceGroup)
            - ${{ if eq(variables.IsContainerRegistry,true) }}:
              - name: platform-container-registry
                path: infra/bootstrap/env-shared/container-registry
                resourceGroupName: $(ssvSharedResourceGroup)
            - ${{ if eq(variables.IsLogAnalyticsWorkspace,true) }}:
              - name: log-analytics-workspace
                path: infra/common/operational-insights
                parameterFilePath: infra/bootstrap/env-shared/log-analytics-workspace
                resourceGroupName: $(ssvSharedResourceGroup)
            - ${{ if eq(variables.IsEventHubNamespace, true) }}:                    
              - name: namespace
                path: infra/bootstrap/env-shared/event-hub
                resourceGroupName: $(ssvSharedResourceGroup)
                privateEndpointDnsRecordsForResources:
                  - resourceName: $(ssvResourceNamePrefix)$(nc_resource_eventhub)$(nc_shared_instance_regionid)01
                    resourceGroupName: $(ssvSharedResourceGroup)