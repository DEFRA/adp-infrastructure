name: 1.0.$(BuildID)-${{ parameters.deployResources }}

parameters:
  - name: deployFromFeature
    displayName: "Deploy from Feature Branch"
    type: boolean
    default: false
  - name: deployResources
    displayName: "Resources to Deploy"
    type: string
    default: "All"
    values:
      - All
      - Shared Event Hub
      - Application Gateway Backends

pr:
  branches:
    include:
      - main
  paths:
    include:
      - infra/env-shared/*

trigger:
  batch: true
  branches:
    include:
      - '*'
  paths:
    include:
      - infra/env-shared/*
      # - infra/common/policy-assignment/*

resources:
  repositories:
    - repository: ADPPipelineCommon
      name: DEFRA/adp-pipeline-common
      endpoint: DEFRA
      type: github
      ref: gg/304334-Sec-AppGW-Variables #main

variables:
  - name: IsAll
    value: ${{ eq(parameters.deployResources,'All') }}
  - name: IsApplicationEventHub
    value: ${{ or(eq(variables.IsAll,true), eq(parameters.deployResources,'Shared Event Hub')) }}
  - name: IsApplicationGatewayBackends
    value: ${{ or(eq(variables.IsAll,true), eq(parameters.deployResources,'Application Gateway Backends')) }}  

extends:
  template: /pipelines/common-infra-deploy.yaml@ADPPipelineCommon
  parameters:
    projectName: $(projectName)
    deployFromFeature: ${{ parameters.deployFromFeature }}
    environments:
      - name: 'ssv_dev'
        serviceConnection: AZD-ADP-SSV3
        deploymentBranches:
          - 'refs/heads/main'
        # developmentEnvironment: true
        azureRegions:
          primary: 'UKSouth'
      - name: 'ssv_tst'
        serviceConnection: AZD-ADP-SSV3
        developmentEnvironment: true
        deploymentBranches:
          - 'refs/heads/main'
        azureRegions:
          primary: 'UKSouth'
      - name: 'ssv_pre'
        serviceConnection: AZR-ADP-SSV5
        deploymentBranches:
          - 'refs/heads/main'
        azureRegions:
          primary: 'UKSouth'    
      - name: 'ssv_prd'
        serviceConnection: AZR-ADP-SSV5
        deploymentBranches:
          - 'refs/heads/main'
        azureRegions:
          primary: 'UKSouth'  
    groupedDeployments:
         - name: SharedEnvironment
           deployments:
            - ${{ if eq(variables.IsApplicationEventHub, true) }}:                    
              - name: namespace
                path: infra/env-shared/event-hub
                resourceGroupName: $(ssvInfraResourceGroup)
                privateEndpointDnsRecordsForResources:
                  - resourceName: $(eventHubName)
                    resourceGroupName: $(ssvInfraResourceGroup)
            - ${{ if eq(variables.IsApplicationGatewayBackends, true) }}:                    
              - name: application-gateway-backends
                path: infra/env-shared/application-gateway
                resourceGroupName: $(secAppGWResourceGroup)
                serviceConnectionVariableName: 'secServiceConnection'
                preDeployScriptsList: 
                  - displayName: Get ContainerApp IngressFqdn to use it in App Gateway backend pool
                    scriptPath: infra/env-shared/scripts/Get-ContainerAppIngressFqdn.ps1
                    type: AzurePowerShell
                    scriptArguments: >
                      -ResourceGroupName $(ssvInfraResourceGroup)
                      -ContainerAppName $(portalWebContainerAppName)          