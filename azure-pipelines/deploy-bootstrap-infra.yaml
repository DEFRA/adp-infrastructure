parameters:
  - name: deployToDevelopmentEnvironment
    displayName: 'Deploy from Feature Branch'
    type: boolean
    default: false

trigger: none

resources:
  repositories:
    - repository: PipelineCommon
      name: DEFRA-DEVOPS-COMMON/Defra.Pipeline.Common
      type: git
      ref: refs/tags/Release-v5.5.13
    - repository: BicepModules
      type: github
      endpoint: defra-adp-sandpit
      name: defra-adp-sandpit/ResourceModules

extends:
  template: /templates/pipelines/common-infrastructure-deploy.yaml@PipelineCommon
  parameters:
    projectName: $(projectName)
    deployFromFeature: ${{ parameters.deployToDevelopmentEnvironment }}
    environments:
      - name: 'snd1'
        deploymentBranches:
          - 'refs/heads/*'
        developmentEnvironment: True
        azureRegions:
          primary: UKSouth
        serviceConnection: AZD-CDO-SSV3
      - name: 'snd2'
        deploymentBranches:
          - '*'
        azureRegions:
          primary: UKSouth
        serviceConnection: AZD-CDO-SSV3
      - name: 'snd3'
        deploymentBranches:
          - '*'
        azureRegions:
          primary: UKSouth
        serviceConnection: AZD-CDO-SSV3
    variableFiles:
      - /azure-pipelines/vars/common.yaml@self
      - /azure-pipelines/vars/{environment}.yaml@self
    groupedTemplates:
      - name: Networking
        templates:
          - name: network-security-group
            path: infra/bicep/network-security-group
            type: bicep
            scope: 'Resource Group'
            acrServiceConnection: AZD-CDO-SSV3
            resourceGroupName: $(resourceGroup)
          - name: virtual-network
            path: infra/bicep/virtual-network
            type: bicep
            scope: 'Resource Group'
            acrServiceConnection: AZD-CDO-SSV3
            resourceGroupName: $(netResourceGroup)
